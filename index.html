<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ¡IMPORTANTE para iOS! Esta meta tag elimina la barra de Safari y la convierte en una app de pantalla completa. -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Rastreador Piti & Emi</title>
    
    <!-- --- Íconos (Mantenidos) --- -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/6495ED,FF69B4/FFFFFF/png?text=P+%26+E&font=sans" sizes="180x180">
    <link rel="icon" href="https://placehold.co/32x32/6495ED,FF69B4/FFFFFF/png?text=P+%26+E&font=sans" sizes="32x32">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar un font similar a iOS (Inter) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Estilo para simular el efecto de las cards de iOS */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(229, 231, 235, 0.5); /* light gray border */
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9); /* slight transparency */
        }
        /* Estilo para los botones principales */
        .action-button {
            transition: all 0.15s ease-in-out;
        }
        .action-button:active:not(:disabled) {
            transform: scale(0.98);
        }
        /* Estilo para botones deshabilitados */
        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            filter: grayscale(0.5);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

    <div id="app-container" class="w-full max-w-md">
        <!-- Título principal -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Rastreador de Saldos</h1>
            <!-- El estado de autenticación ahora indica el modo LocalStorage -->
            <p id="auth-status" class="text-xs text-red-600 font-semibold mt-1">Cargando...</p>
        </header>

        <!-- Contenedor de Saldos (Cards) -->
        <div id="balance-display" class="grid grid-cols-2 gap-4 mb-8">
            <!-- Card Piti -->
            <div class="card p-5 rounded-xl text-center bg-blue-500/10 border-blue-200">
                <p class="text-sm font-semibold text-blue-800 uppercase">Piti</p>
                <p id="piti-total" class="text-4xl font-bold mt-1 text-blue-900 tracking-tight transition duration-300">
                    $0
                </p>
            </div>
            <!-- Card Emi -->
            <div class="card p-5 rounded-xl text-center bg-pink-500/10 border-pink-200">
                <p class="text-sm font-semibold text-pink-800 uppercase">Emi</p>
                <p id="emi-total" class="text-4xl font-bold mt-1 text-pink-900 tracking-tight transition duration-300">
                    $0
                </p>
            </div>
        </div>

        <!-- Panel de Ingreso de Datos -->
        <div class="card p-6 rounded-xl space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Ingresar Monto</h2>

            <!-- Input de Monto -->
            <div>
                <label for="amount-input" class="block text-sm font-medium text-gray-600 mb-2">Monto a agregar (ej: 2000)</label>
                <input type="number" id="amount-input" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" inputmode="decimal">
            </div>

            <!-- Botones de Acción -->
            <div class="flex space-x-3 pt-2">
                <!-- Los botones se deshabilitan al inicio con JS -->
                <button id="add-piti" class="action-button flex-1 py-3 px-4 bg-gray-400 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500/50 shadow-lg shadow-blue-500/30" disabled>
                    Añadir a Piti
                </button>
                <button id="add-emi" class="action-button flex-1 py-3 px-4 bg-gray-400 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-pink-500/50 shadow-lg shadow-pink-500/30" disabled>
                    Añadir a Emi
                </button>
            </div>

            <!-- Mensajes de Error y Éxito -->
            <p id="message-box" class="text-sm text-center pt-2 h-6"></p>
        </div>
        
        <!-- Contenedor para mostrar el ID de usuario -->
        <div class="mt-8 text-center text-xs text-gray-500 p-3 bg-gray-200 rounded-lg">
            <p>Tipo de Persistencia: <span id="app-id-display" class="font-mono text-gray-700">LOCAL</span></p>
            <p>ID de Dispositivo: <span id="user-id-display" class="font-mono text-gray-700">Persistencia local activa</span></p>
        </div>
    </div>

    <!-- Lógica de la Aplicación con LocalStorage (No requiere Firebase) -->
    <script type="module">
        // --- Variables de Estado y Configuración de LocalStorage ---
        const PITI_KEY = 'pitiBalance';
        const EMI_KEY = 'emiBalance';

        let pitiTotal = 0;
        let emiTotal = 0;
        let isAppReady = false; 
        
        // Referencias del DOM
        const pitiTotalEl = document.getElementById('piti-total');
        const emiTotalEl = document.getElementById('emi-total');
        const amountInput = document.getElementById('amount-input');
        const addPitiButton = document.getElementById('add-piti');
        const addEmiButton = document.getElementById('add-emi');
        const messageBox = document.getElementById('message-box');
        const authStatusEl = document.getElementById('auth-status');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // Formatear número a formato de moneda local
        const formatter = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP', // Usamos CLP (Peso Chileno) como ejemplo
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        // Función para mostrar mensajes temporales en la UI
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = isError 
                ? 'text-sm text-center pt-2 h-6 text-red-600' 
                : 'text-sm text-center pt-2 h-6 text-green-600';
            setTimeout(() => {
                messageBox.textContent = '';
                messageBox.className = 'text-sm text-center pt-2 h-6';
            }, 3000);
        }

        // Función para habilitar/deshabilitar botones y cambiar su estilo
        function updateButtonState(ready) {
            addPitiButton.disabled = !ready;
            addEmiButton.disabled = !ready;
            
            // Estilos para Piti
            addPitiButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400');
            if (ready) {
                addPitiButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-500/30');
                addPitiButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
            } else {
                addPitiButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                addPitiButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-500/30');
            }

            // Estilos para Emi
            addEmiButton.classList.remove('bg-pink-600', 'hover:bg-pink-700', 'bg-gray-400');
            if (ready) {
                addEmiButton.classList.add('bg-pink-600', 'hover:bg-pink-700', 'shadow-pink-500/30');
                addEmiButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
            } else {
                addEmiButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                addEmiButton.classList.remove('bg-pink-600', 'hover:bg-pink-700', 'shadow-pink-500/30');
            }
        }

        // --- 1. Funciones de Carga y Guardado de LocalStorage ---
        function loadBalances() {
            try {
                // Cargar saldos, si no existen, usar 0
                pitiTotal = parseFloat(localStorage.getItem(PITI_KEY)) || 0;
                emiTotal = parseFloat(localStorage.getItem(EMI_KEY)) || 0;
            } catch (e) {
                console.error("Error al cargar de localStorage:", e);
                // Si falla la carga (ej. storage lleno), los saldos se mantienen en 0.
            }
        }

        function saveBalances() {
            try {
                // Guardar saldos en localStorage
                localStorage.setItem(PITI_KEY, pitiTotal.toString());
                localStorage.setItem(EMI_KEY, emiTotal.toString());
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                showMessage("ERROR al guardar datos. Memoria del dispositivo llena o bloqueada.", true);
            }
        }
        
        // --- 2. Función para actualizar la UI ---
        function updateUI() {
            pitiTotalEl.textContent = formatter.format(pitiTotal);
            emiTotalEl.textContent = formatter.format(emiTotal);
        }

        // --- 3. Inicialización de la Aplicación ---
        function setupLocalStorage() {
            loadBalances(); // Cargar datos persistentes
            updateUI();     // Mostrar datos cargados
            
            authStatusEl.textContent = "Modo LOCAL y PERSISTENTE. Los datos se guardan en este dispositivo.";
            
            isAppReady = true;
            updateButtonState(true); // Habilitar botones de acción
        }

        // --- 4. Función para actualizar el saldo (Localmente) ---
        function updateBalance(targetKey) {
            if (!isAppReady) { 
                showMessage("Error: La aplicación no está lista.", true);
                return;
            }
            
            const amountValue = parseFloat(amountInput.value);
            if (isNaN(amountValue) || amountValue <= 0) {
                showMessage("Por favor, ingresa un monto válido (mayor a 0).", true);
                return;
            }

            // Deshabilitar botones (feedback visual rápido)
            updateButtonState(false);

            // Actualizar saldos
            if (targetKey === 'piti') {
                pitiTotal += amountValue;
            } else if (targetKey === 'emi') {
                emiTotal += amountValue;
            }

            saveBalances(); // Guardar en localStorage
            updateUI();     // Actualizar la interfaz

            showMessage(`Se agregaron ${formatter.format(amountValue)} a ${targetKey === 'piti' ? 'Piti' : 'Emi'}.`, false);
            amountInput.value = ''; // Limpiar el input
            
            updateButtonState(true); // Habilitar botones
        }

        // --- 5. Asignación de Eventos ---
        addPitiButton.addEventListener('click', () => updateBalance('piti'));
        addEmiButton.addEventListener('click', () => updateBalance('emi'));

        // Iniciar la aplicación
        setupLocalStorage();

    </script>
</body>
</html>
