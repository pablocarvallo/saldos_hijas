<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ¡IMPORTANTE para iOS! Esta meta tag elimina la barra de Safari y la convierte en una app de pantalla completa. -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Rastreador Piti & Emi</title>
    
    <!-- --- NUEVOS ÍCONOS AÑADIDOS --- -->
    <!-- Ícono para la pantalla de inicio de iOS (Apple Touch Icon - 180x180px) -->
    <!-- Reemplaza esta URL por tu propia imagen PNG de 180x180px. -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/6495ED,FF69B4/FFFFFF/png?text=P+%26+E&font=sans" sizes="180x180">
    <!-- Ícono genérico (Favicon) -->
    <link rel="icon" href="https://placehold.co/32x32/6495ED,FF69B4/FFFFFF/png?text=P+%26+E&font=sans" sizes="32x32">
    <!-- --------------------------- -->

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar un font similar a iOS (Inter) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Estilo para simular el efecto de las cards de iOS */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(229, 231, 235, 0.5); /* light gray border */
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9); /* slight transparency */
        }
        /* Estilo para los botones principales */
        .action-button {
            transition: all 0.15s ease-in-out;
        }
        .action-button:active:not(:disabled) {
            transform: scale(0.98);
        }
        /* Estilo para botones deshabilitados */
        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            filter: grayscale(0.5);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

    <div id="app-container" class="w-full max-w-md">
        <!-- Título principal -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Rastreador de Saldos</h1>
            <p id="auth-status" class="text-xs text-gray-500 mt-1">Cargando...</p>
        </header>

        <!-- Contenedor de Saldos (Cards) -->
        <div id="balance-display" class="grid grid-cols-2 gap-4 mb-8">
            <!-- Card Piti -->
            <div class="card p-5 rounded-xl text-center bg-blue-500/10 border-blue-200">
                <p class="text-sm font-semibold text-blue-800 uppercase">Piti</p>
                <p id="piti-total" class="text-4xl font-bold mt-1 text-blue-900 tracking-tight transition duration-300">
                    $0
                </p>
            </div>
            <!-- Card Emi -->
            <div class="card p-5 rounded-xl text-center bg-pink-500/10 border-pink-200">
                <p class="text-sm font-semibold text-pink-800 uppercase">Emi</p>
                <p id="emi-total" class="text-4xl font-bold mt-1 text-pink-900 tracking-tight transition duration-300">
                    $0
                </p>
            </div>
        </div>

        <!-- Panel de Ingreso de Datos -->
        <div class="card p-6 rounded-xl space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Ingresar Monto</h2>

            <!-- Input de Monto -->
            <div>
                <label for="amount-input" class="block text-sm font-medium text-gray-600 mb-2">Monto a agregar (ej: 2000)</label>
                <input type="number" id="amount-input" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" inputmode="decimal">
            </div>

            <!-- Botones de Acción -->
            <div class="flex space-x-3 pt-2">
                <!-- Los botones se deshabilitan al inicio con JS -->
                <button id="add-piti" class="action-button flex-1 py-3 px-4 bg-gray-400 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500/50 shadow-lg shadow-blue-500/30" disabled>
                    Añadir a Piti
                </button>
                <button id="add-emi" class="action-button flex-1 py-3 px-4 bg-gray-400 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-pink-500/50 shadow-lg shadow-pink-500/30" disabled>
                    Añadir a Emi
                </button>
            </div>

            <!-- Mensajes de Error y Éxito -->
            <p id="message-box" class="text-sm text-center pt-2 h-6"></p>
        </div>
        
        <!-- Contenedor para mostrar el ID de usuario -->
        <div class="mt-8 text-center text-xs text-gray-500 p-3 bg-gray-200 rounded-lg">
            <p>ID de la aplicación (para persistencia): <span id="app-id-display" class="font-mono text-gray-700">Cargando...</span></p>
            <p>ID de Usuario: <span id="user-id-display" class="font-mono text-gray-700">Autenticando...</span></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            runTransaction,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro de Firestore a Debug
        setLogLevel('Debug');

        // --- Variables de Entorno y Configuración de Firebase (proporcionadas por Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'Autenticando...';
        let isAppReady = false; // Estado para controlar si la app está lista para interactuar
        
        // Referencias del DOM
        const pitiTotalEl = document.getElementById('piti-total');
        const emiTotalEl = document.getElementById('emi-total');
        const amountInput = document.getElementById('amount-input');
        const addPitiButton = document.getElementById('add-piti');
        const addEmiButton = document.getElementById('add-emi');
        const messageBox = document.getElementById('message-box');
        const authStatusEl = document.getElementById('auth-status');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // Mostrar ID de la App
        appIdDisplay.textContent = appId;

        // Rutas y colecciones
        // Usamos una ruta pública para que el saldo sea compartido y persistente para esta app.
        const BALANCES_DOC_PATH = `artifacts/${appId}/public/data/balances/totals`;
        
        // Formatear número a formato de moneda local
        const formatter = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP', // Usamos CLP (Peso Chileno) como ejemplo
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        // Función para mostrar mensajes temporales en la UI
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = isError 
                ? 'text-sm text-center pt-2 h-6 text-red-600' 
                : 'text-sm text-center pt-2 h-6 text-green-600';
            setTimeout(() => {
                messageBox.textContent = '';
                messageBox.className = 'text-sm text-center pt-2 h-6';
            }, 3000);
        }

        // Función para habilitar/deshabilitar botones y cambiar su estilo
        function updateButtonState(ready) {
            addPitiButton.disabled = !ready;
            addEmiButton.disabled = !ready;
            
            // Estilos para Piti
            addPitiButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400');
            if (ready) {
                addPitiButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-500/30');
                addPitiButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
            } else {
                addPitiButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                addPitiButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-500/30');
            }

            // Estilos para Emi
            addEmiButton.classList.remove('bg-pink-600', 'hover:bg-pink-700', 'bg-gray-400');
            if (ready) {
                addEmiButton.classList.add('bg-pink-600', 'hover:bg-pink-700', 'shadow-pink-500/30');
                addEmiButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
            } else {
                addEmiButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none');
                addEmiButton.classList.remove('bg-pink-600', 'hover:bg-pink-700', 'shadow-pink-500/30');
            }
        }

        // --- 1. Inicialización y Autenticación de Firebase (Flujo Sincrónico Mejorado) ---
        async function setupFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config no está disponible.");
                    authStatusEl.textContent = "Error: Configuración de Firebase no disponible.";
                    updateButtonState(false);
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Intento de autenticación (sincrónico, espera a que se complete)
                let userCredential;
                if (initialAuthToken) {
                    userCredential = await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    userCredential = await signInAnonymously(auth);
                }

                // Si la autenticación es exitosa, el userCredential contiene el usuario.
                const user = userCredential.user;
                userId = user.uid;
                authStatusEl.textContent = "Conectado y datos guardados de forma persistente.";
                userIdDisplay.textContent = userId;
                console.log("Usuario autenticado. UID:", userId);

                // Marcar la aplicación como lista para interactuar y habilitar botones
                isAppReady = true;
                updateButtonState(true);

                // Inicializar y escuchar los datos solo después de la autenticación exitosa.
                initDataListener();
                
            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                authStatusEl.textContent = "Error fatal al iniciar la aplicación. Los datos no se guardarán.";
                userIdDisplay.textContent = "ERROR";
                updateButtonState(false);
            }
        }

        // --- 2. Listener de Datos en Tiempo Real (onSnapshot) ---
        function initDataListener() {
            if (!db) return; // Asegurar que db esté inicializado

            const docRef = doc(db, BALANCES_DOC_PATH);

            onSnapshot(docRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Datos encontrados: Actualizar la UI
                    const data = docSnapshot.data();
                    const pitiTotal = data.pitiTotal || 0;
                    const emiTotal = data.emiTotal || 0;
                    
                    pitiTotalEl.textContent = formatter.format(pitiTotal);
                    emiTotalEl.textContent = formatter.format(emiTotal);
                    console.log(`Datos actualizados. Piti: ${pitiTotal}, Emi: ${emiTotal}`);
                } else {
                    // El documento no existe: Inicializarlo con 0
                    const initialData = { pitiTotal: 0, emiTotal: 0, lastUpdate: new Date().toISOString() };
                    try {
                        await setDoc(docRef, initialData);
                        console.log("Documento de balances inicializado en Firestore.");
                    } catch (e) {
                        console.error("Error al inicializar el documento:", e);
                    }
                }
            }, (error) => {
                console.error("Error en el listener de Firestore:", error);
                showMessage("Error al cargar los datos en tiempo real.", true);
            });
        }

        // --- 3. Función para actualizar el saldo (con Transacciones) ---
        async function updateBalance(target) {
            // DOBLE VERIFICACIÓN: Si la aplicación no está lista, salimos
            if (!isAppReady || !db || !auth.currentUser) {
                // Mensaje de error ajustado.
                showMessage("Error: La aplicación se está cargando o hay un error de conexión. Por favor, espera unos segundos.", true);
                return;
            }

            const amountValue = parseFloat(amountInput.value);
            if (isNaN(amountValue) || amountValue <= 0) {
                showMessage("Por favor, ingresa un monto válido (mayor a 0).", true);
                return;
            }

            const docRef = doc(db, BALANCES_DOC_PATH);
            updateButtonState(false); // Deshabilitar temporalmente durante la transacción

            try {
                // Usamos runTransaction para asegurar que la lectura y la escritura sean atómicas.
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) {
                        // Si el documento no existe, lo inicializamos dentro de la transacción.
                        transaction.set(docRef, { pitiTotal: 0, emiTotal: 0, lastUpdate: new Date().toISOString() });
                        // Luego volvemos a intentar la transacción (Firestore la reintentará automáticamente).
                        throw new Error("Documento inicializado, reintentando..."); 
                    }

                    const newBalance = (sfDoc.data()[target] || 0) + amountValue;
                    
                    // Crear el objeto de actualización
                    const updateObject = {
                        [target]: newBalance,
                        lastUpdate: new Date().toISOString()
                    };
                    
                    transaction.update(docRef, updateObject);
                });

                showMessage(`Se agregaron ${formatter.format(amountValue)} a ${target === 'pitiTotal' ? 'Piti' : 'Emi'}.`, false);
                amountInput.value = ''; // Limpiar el input

            } catch (e) {
                // Si el error fue la inicialización, la transacción se reintentará automáticamente.
                // Si es un error de conexión grave, lo mostramos.
                if (e.message && e.message.includes("Documento inicializado")) {
                    console.log(e.message);
                } else {
                    console.error("Error al actualizar el saldo:", e);
                    showMessage("Error al actualizar el saldo. Intenta de nuevo.", true);
                }

            } finally {
                updateButtonState(true); // Habilitar de nuevo al finalizar
            }
        }

        // --- 4. Asignación de Eventos ---
        addPitiButton.addEventListener('click', () => updateBalance('pitiTotal'));
        addEmiButton.addEventListener('click', () => updateBalance('emiTotal'));

        // Iniciar la aplicación
        setupFirebaseAndAuth();

    </script>
</body>
</html>
